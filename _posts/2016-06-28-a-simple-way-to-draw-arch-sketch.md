---
layout: post
title: 懒人画架构框图的方法
author: lili01
categories: ['arch']
tags: ['arch', 'xmind', 'sketch']
published: True
description: 一般情况下，我们都是用visio、graffle甚至是PPT之类的工具来绘制架构框架，但是当框图结构比较复杂，涉及的构件很多时，每次对结构做调整都是件很痛苦的事情。作为一个懒人，自然希望能有一个简单的方法。
---


## 背景

一般情况下，我们都是用visio、graffle甚至是PPT之类的工具来绘制架构框架，但是当框图结构比较复杂，涉及的构件很多时，每次对结构做调整都是件很痛苦的事情。比如下面这张图，随便修改一点儿，都是件大工程。

![架构图]({{ site.url }}/images/2016-06-28/p2.png)

作为一个懒人，自然希望能有一个简单的方法。其实，在缓制这类框图时，真正有价值的信息是图上各个元素之件的从属和拓扑关系。至于元素如何布局，是不是严格对齐，是不是足够美观等等，都是次要。但事实情况往往恰恰相关，图上的元素稍多一点儿，布局、对齐的工作都会变得非常繁琐，占用大量的时间，甚至远远多于思考架构本身的时间。

那么，有没有可能像脑图软件那样，只需要通过某种方式输入元素及元素间的关系，然后由计算机代劳自动生成对应的框图呢？

## 什么是架构框图

即然要自动生成，就得有规律可依才行。如果是范范的来看，框图的绘制几乎没有什么规则可言，如何布局，全看绘图者的心情。但如果把范围缩小到架构框图，问题可能就简单很多了。

即然是架构框图，那么它一定是要符合架构设计的一般规律的。而架构，本质上就是对系统的边界切分，这就意味着它基本上是一个树型结构，只不过，与脑图不同的是，脑图可以看作是一棵二维的树，可以很容易在一个平面上展开。而架构图多了一个分层的概念，使得它更像一棵三维的树。

先来举个例子，如下图所示：

![架构图]({{ site.url }}/images/2016-06-28/p1.png)

这是一个比较典型的架构框图。图中，框的嵌套关系代表了不同级别的系统或模块的从属关系，同一级别相邻的模块是对上一级模块的细分，左右相邻的模块往往没有直接的依懒关系。而上下相邻的模块通常意味着，位于上方的模块依懒于下方的模块，也就是一般所说的分层的概念。图中还有一些浅绿色的纵向放置的框，它通常代表了被同级的其它模块共同使用的一些基础架构、组件、基类等，简单启见，后文所这种关系称之为USE关系。

以上图为例，它将整系统拆分为产品架构、基础设施、平台三大子系统，其中产品架构构建在基础设施之上。产品架构由细分为在线架构、离线架构二个相对独立的部分，其中在线架构又分为两个大层，APP、SERVER。以次类推，对整个系统不断的进行细分，最终便形成了文章开头的架构图。

如果一个上层模块，依懒下多个下层模块该怎么画呢？对于这样种情况，笔者的经验是把多个被依懒的模块组合成一个逻辑模块，让上层模块依懒这个逻辑模块。这样，整个架构里，就可以严格的实现一个上层模块只依懒一个下层模块或逻辑模块。但一个下层模块或逻辑模块可以被多个上层模块依懒。同时，依懒只存在于相邻的模块之间，不存在跨层的直接依懒。为了简单启见，后文将上述原则称之BASE ON原则，而符合BASE ON原则的依懒关系则简称为BASE ON关系。通常情况下，一个合理的架构都应该是符合BASE ON原则的。

## 用脑图来画框图

有了BASE ON原则后，架构图也可就可以看做是树形图 + BASE ON关系后的产物了，那么，是不是也就意味只要想办法在脑图中方便的描述这种BASE ON关系，也就可以通过工作，将脑图自动的转化架构图了呢？如下图所示：

![脑图]({{ site.url }}/images/2016-06-28/p3.png)

上一节里的架构图其实就是用上面的这张脑图生成的，脑图使用xmind软件绘制，脑图中的结点的拆分，描述了模块间的从属关系，而脑图中的虚线箭头就代表了前文所述的BASE ON关系。脑图上的概要结点与架构图中的USE关系相对应。结点上的图标则是用来控制结点的显示效果的，比如数字代表布局时计算宽度的权重，+号、-号则是计算高度时的权重，对号、叉号可置设计结点的边框样式等等。

接下来要做的事情无非就是写个脚本，读取xmind的脑图文件（xmind文件其实就是一堆用ZIP打包后的XML），解析出上述信息，再生成缓制架构图的坐标数据。最后跟据需要，生成HTML、GRAFFLE脚本或者VISO脚本。然后，就有了本文最前面的那张图了。

完成的脚本代码：[sketch.zip]({{ site.url }}/images/2016-06-28/sketch.zip)

调试环境：

    Mac OS + Python 2.7

使用方法：

    ./sketch.py path/to/xxx.xmind 



------------------
&copy; 本文版权所有，转载引用请注明出处
